# 🚀 Po-Todo-List 服务器部署说明

本项目提供了多种部署方式，您可以根据实际情况选择最适合的部署方案。

## 📦 部署文件说明

| 文件名 | 用途 | 说明 |
|--------|------|------|
| `Dockerfile` | Docker镜像构建 | 已优化的生产环境镜像配置 |
| `docker-compose.yml` | 容器编排 | 包含数据持久化和健康检查 |
| `deploy.sh` | 部署管理脚本 | 用于已有Docker环境的服务器 |
| `quick-deploy.sh` | 一键部署脚本 | 适用于全新服务器，自动安装依赖 |
| `init-db.sh` | 数据库初始化脚本 | 自动创建数据库表和初始数据 |
| `.env.production` | 生产环境配置 | 环境变量模板 |
| `nginx.conf` | Nginx配置 | 反向代理配置模板 |
| `DEPLOYMENT.md` | 详细部署文档 | 完整的部署指南和故障排除 |

## 🎯 快速部署（推荐）

### 方案一：全新服务器一键部署

适用于：全新的 Linux 服务器，未安装 Docker

```bash
# 1. 上传项目到服务器
scp -r po-todo-list/ user@your-server:/opt/

# 2. 登录服务器并执行一键部署
ssh user@your-server
cd /opt/po-todo-list
sudo ./quick-deploy.sh
```

### 方案二：已有Docker环境部署

适用于：已安装 Docker 和 Docker Compose 的服务器

```bash
# 1. 上传项目到服务器
scp -r po-todo-list/ user@your-server:/opt/

# 2. 登录服务器并部署
ssh user@your-server
cd /opt/po-todo-list

# 3. 构建并启动
./deploy.sh build
./deploy.sh start
```

### 方案三：手动Docker部署

适用于：需要自定义配置的场景

```bash
# 1. 构建镜像
docker-compose build

# 2. 启动服务
docker-compose up -d

# 3. 查看状态
docker-compose ps
docker-compose logs
```

## 💾 数据持久化说明

### SQLite数据库挂载
**重要：** 为确保容器重启后数据不丢失，项目已正确配置数据持久化：

1. **本地数据目录**：`./data` 
2. **容器内路径**：`/app/data`
3. **数据库文件**：`potodo.db`
4. **完整路径**：`./data/potodo.db` → `/app/data/potodo.db`

### 数据持久化配置
```yaml
# docker-compose.yml 中的卷挂载
volumes:
  - ./data:/app/data  # SQLite数据库文件持久化
  - ./logs:/app/logs  # 日志文件持久化

# 环境变量确保数据库路径正确
environment:
  - SPRING_DATASOURCE_URL=jdbc:sqlite:/app/data/potodo.db
```

### 数据库初始化
```bash
# 运行数据库初始化脚本
./init-db.sh
```

### 数据持久化验证
```bash
# 验证数据是否正确挂载和持久化
./verify-data.sh
```

**验证要点：**
- ✅ 本地 `./data` 目录存在
- ✅ 数据库文件 `./data/potodo.db` 正确创建
- ✅ 容器内 `/app/data` 目录正确挂载
- ✅ 环境变量 `SPRING_DATASOURCE_URL` 配置正确
- ✅ 应用可以正常访问数据库

## ⚙️ 生产环境配置

### 1. 环境变量配置

```bash
# 复制并编辑环境配置
cp .env.production .env
vim .env
```

### 2. Nginx 反向代理（推荐）

```bash
# 安装 Nginx
sudo apt install nginx  # Ubuntu/Debian
sudo yum install nginx  # CentOS/RHEL

# 配置 Nginx
sudo cp nginx.conf /etc/nginx/sites-available/po-todo-list
sudo ln -s /etc/nginx/sites-available/po-todo-list /etc/nginx/sites-enabled/

# 编辑配置文件，替换域名
sudo vim /etc/nginx/sites-available/po-todo-list

# 重启 Nginx
sudo systemctl restart nginx
```

### 3. 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 8081

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=8081/tcp
sudo firewall-cmd --reload
```

## 🔧 常用管理命令

```bash
# 查看服务状态
./deploy.sh logs

# 重启服务
./deploy.sh restart

# 停止服务
./deploy.sh stop

# 更新应用
git pull
./deploy.sh restart

# 备份数据
cp data/potodo.db backup/potodo_$(date +%Y%m%d_%H%M%S).db
```

## 🌐 访问应用

部署成功后，您可以通过以下地址访问：

- **应用首页**: `http://your-server-ip:8081`
- **登录页面**: `http://your-server-ip:8081/login.html`
- **任务管理**: `http://your-server-ip:8081/todo.html`
- **数据分析**: `http://your-server-ip:8081/analytics.html`

## 🆘 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   sudo netstat -tlnp | grep :8081
   # 修改 .env 文件中的端口配置
   ```

2. **容器启动失败**
   ```bash
   docker-compose logs po-todo-list
   docker stats
   ```

3. **权限问题**
   ```bash
   sudo chown -R $USER:$USER /opt/po-todo-list
   chmod +x deploy.sh quick-deploy.sh
   ```

### 获取帮助

- 查看详细文档：`cat DEPLOYMENT.md`
- 查看部署脚本帮助：`./deploy.sh help`
- 检查系统资源：`docker stats`
- 查看系统日志：`journalctl -u docker`

## 📋 系统要求

- **操作系统**: Linux (Ubuntu 20.04+, CentOS 7+)
- **内存**: 最少 1GB RAM
- **存储**: 最少 2GB 可用空间
- **网络**: 开放端口 8081 (或自定义端口)

## 🔒 安全建议

1. 定期更新系统和 Docker
2. 配置 SSL 证书（HTTPS）
3. 设置防火墙规则
4. 定期备份数据
5. 监控系统资源使用情况

---

**需要更多帮助？** 请查看 `DEPLOYMENT.md` 获取详细的部署指南和故障排除方案。